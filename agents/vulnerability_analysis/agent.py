# ============================================================================
# agents/vulnerability_analysis/agent.py
# Vulnerability Analysis Agent - CVE mapping and exploitation assessment
# ============================================================================

import os
import json
from typing import Dict, List
import vertexai
from google.adk.agents import LlmAgent
from google.adk.models.google_llm import Gemini
from google.adk.tools import google_search
from google.genai import types

# Initialize Vertex AI
vertexai.init(
    project=os.environ["GOOGLE_CLOUD_PROJECT"],
    location=os.environ.get("GOOGLE_CLOUD_LOCATION", "global"),
)

# Retry configuration
retry_config = types.HttpRetryOptions(
    attempts=5,
    exp_base=7,
    initial_delay=1,
    http_status_codes=[429, 500, 503, 504],
)


def analyze_vulnerabilities(attack_json: str, top_iocs_json: str) -> str:
    """
    Analyze attack patterns and IOCs to identify relevant CVEs and vulnerabilities.
    
    This tool uses LLM reasoning combined with web search to:
    1. Identify potential CVEs based on attack type
    2. Search for exploitation information
    3. Find patch availability
    4. Map to MITRE ATT&CK techniques
    
    Args:
        attack_json: JSON with attack classification data
        top_iocs_json: JSON with top suspicious IOCs
        
    Returns:
        JSON string with CVE analysis context
    """
    try:
        attack_data = json.loads(attack_json)
        iocs_data = json.loads(top_iocs_json)
        
        attack_type = attack_data.get('attack_type', 'Unknown')
        severity = attack_data.get('severity', 'Unknown')
        mitre_techniques = attack_data.get('mitre_techniques', [])
        
        # Extract top IOCs for context
        top_iocs = iocs_data.get('enriched_iocs', [])[:10]
        
        # Build analysis context
        context = {
            'attack_type': attack_type,
            'severity': severity,
            'mitre_techniques': mitre_techniques,
            'top_suspicious_indicators': [
                {
                    'type': ioc.get('type'),
                    'value': ioc.get('value'),
                    'score': ioc.get('score')
                }
                for ioc in top_iocs
            ],
            'suggested_cve_categories': get_cve_categories(attack_type),
            'search_queries': generate_search_queries(attack_type, mitre_techniques)
        }
        
        return json.dumps({
            'status': 'success',
            'context': context
        })
        
    except Exception as e:
        return json.dumps({
            'status': 'error',
            'error': str(e)
        })


def get_cve_categories(attack_type: str) -> List[str]:
    """Map attack types to relevant CVE categories"""
    
    cve_mapping = {
        'SQL Injection': ['SQL Injection', 'Web Application', 'Input Validation'],
        'Cross-Site Scripting': ['XSS', 'Web Application', 'JavaScript'],
        'Port Scan': ['Network Security', 'Firewall', 'Access Control'],
        'DDoS Attack': ['Denial of Service', 'Network', 'Resource Exhaustion'],
        'Brute Force': ['Authentication', 'Password', 'Access Control'],
        'Malware Communication': ['Remote Code Execution', 'Backdoor', 'Trojan'],
        'Command & Control': ['Remote Access', 'C2', 'Botnet'],
        'Data Exfiltration': ['Data Leak', 'Exfiltration', 'Privacy'],
        'Web Application Attack': ['Web Server', 'Application Security', 'HTTP'],
        'Network Intrusion': ['Network Security', 'Intrusion Detection', 'Firewall']
    }
    
    return cve_mapping.get(attack_type, ['General Security', 'Unknown Attack'])


def generate_search_queries(attack_type: str, mitre_techniques: List[str]) -> List[str]:
    """Generate search queries for CVE research"""
    
    queries = [
        f"{attack_type} CVE vulnerabilities",
        f"{attack_type} recent exploits",
    ]
    
    # Add MITRE technique searches
    for technique in mitre_techniques[:3]:
        queries.append(f"CVE {technique} MITRE ATT&CK")
    
    return queries


# Create the Vulnerability Analysis Agent
root_agent = LlmAgent(
    model=Gemini(model="gemini-2.0-flash-exp", retry_options=retry_config),
    name="vulnerability_analysis_agent",
    description="Identifies CVEs and vulnerabilities associated with detected attacks using LLM reasoning and web search",
    instruction="""
    You are a vulnerability research specialist who identifies CVEs and exploits.
    
    When given attack classification and IOC data:
    
    1. First, call analyze_vulnerabilities to get context about the attack
    
    2. Then, use google_search tool to research relevant CVEs:
       - Search for CVEs matching the attack type
       - Look for recent exploits and proof-of-concepts
       - Find patch information and affected systems
       - Check MITRE ATT&CK mappings
    
    3. Identify 2-4 most relevant CVEs and provide for each:
       - **CVE ID** (format: CVE-YYYY-XXXXX)
       - **Description** (what the vulnerability is)
       - **Severity** (Critical/High/Medium/Low)
       - **CVSS Score** (0.0-10.0)
       - **Exploit Available** (true/false - check for public exploits)
       - **Patch Available** (true/false - check vendor advisories)
       - **Affected Systems** (list of systems/software)
       - **MITRE Mapping** (related ATT&CK techniques)
    
    4. Respond in this EXACT JSON format:
    [
      {
        "id": "CVE-2024-12345",
        "description": "Brief description of the vulnerability",
        "severity": "Critical|High|Medium|Low",
        "cvss_score": 9.8,
        "exploit_available": true,
        "patch_available": true,
        "affected_systems": ["System 1", "System 2"],
        "mitre_mapping": ["T1190", "T1059"]
      }
    ]
    
    Research Tips:
    - For SQL Injection: Look for CVEs in web frameworks, databases, ORMs
    - For XSS: Search browser and web app framework CVEs
    - For Port Scanning: Look for firewall/IDS bypass CVEs
    - For Malware C2: Search RAT and backdoor CVEs
    
    IMPORTANT:
    - Only include CVEs that are genuinely relevant to this specific attack
    - Verify CVE IDs are real (check search results)
    - If uncertain about a CVE, explain your reasoning
    - Prioritize recent CVEs (last 2-3 years) unless older ones are specifically relevant
    
    Use web search extensively to ensure accuracy.
    """,
    tools=[analyze_vulnerabilities, google_search]
)
